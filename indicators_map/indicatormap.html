<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8">
    <title>MapYourGrid Heath Score</title>

<style>

:root {
  --mapyourgrid-primary: #036d7a;
  --left-panel-width:500px;
}

body {
  justify-content: center;
  align-items: center;
  color: #222;
  flex-direction: column;
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
}

iframe {
  position: fixed;
  background: #000;
  border: none;
  top: 0; right: 0;
  bottom: 0; left: 0;
  width: 100%;
  height: 100%;
}

.mapbox-improve-map {
    display:none;
}

#map {
position: absolute; top: 0; bottom: 0; width: 100%;
}


h1 {
  text-align: center;
}

h2 {
  position: relative;
  display: inline-block;
  font-size: 2.25rem;
  font-weight: 700;
  color: #2A6D3C;
  padding-bottom: 0.25rem;
  margin: 0;
  font-family: sans-serif;
}

h3 {
  background-color: var(--mapyourgrid-primary);;
    font-size: 1.3rem;
    color: #f4f4f4;
    padding: 2px 10px;
     text-align: center;
  }


.mini-website-icon {
  vertical-align: middle;
  margin-left:15px;
}

.container {
  display: flex;
  flex-wrap: wrap; /* Retour à la ligne auto */
  gap: 16px; /* Espace entre les blocs */
  justify-content: center;
}
.card {
  flex: 1 1 200px; /* Largeur min de 200px, ajustable */
  max-width: 125px;
  border: 1px solid #ccc;
  border-radius: 10px;
  padding: 10px;
  padding-bottom: 0px;
  text-align: center;
  background: #f9f9f9;
}
.card img {
  max-width: 100%;
  height: auto;
  margin-top: 8px;
}

.card b {
  display: block;
  font-size: 14px;
  margin-bottom: 8px;
  height: 45px;
  line-height:1.05;
}

/* Le volet latéral */
.sidepanel {
  position: fixed;
  right: -400px; /* caché par défaut */
  top: 0;
  width: var(--left-panel-width);
  height: 100%;
  background: #f4f4f4;
  box-shadow: -2px 0 5px rgba(0,0,0,0.3);
  transition: right 0.3s ease;
  padding: 20px;
  overflow-y: auto;
  display: none;
}

/* quand il est ouvert */
.sidepanel.open {
  right: 0;
  display: inline-block;
}

/* bouton de fermeture */
.close-btn {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 24px;
  cursor: pointer;
  color: #333;
}

.sidepanel img {
  max-width: 100%;
  border-radius: 10px;
  margin-bottom: 15px;
}

/* ----------- HBAR ------------ */
.fig_hbar_div {
  display: flex; align-items: center; margin: 8px 0;
}

.fig_hbar_label {
  width: 70px;
}

.fig_hbar_line_div {
  height: 20px; background-color: #54a36a; border-radius: 5px; transition: width 0.3s;
}

.fig_hbar_value {
  margin-left: 10px; font-weight: bold;
}

.infobox {
  z-index: 10;
  width: 270px;
  height: 45px;
  background: #ddd;
  border-radius: 20px;
  display: block;
  padding: 15px;
  font-family: sans-serif;
  font-size:1.1em;
  position: relative;
  margin: 10px;
}

/* TOGGLE BOUTON STYLE */

.togglebox {
  z-index: 10;
  width: 220px;
  height: 90px;
  background: #ddd;
  border-radius: 20px;
  display: block;
  padding: 5px;
  font-family: sans-serif;
  position: relative;
  margin: 10px;
}

.toggle {
  position: relative;
  width: 200px;
  display: flex;
  align-items: center;
  padding: 4px;
  font-family: sans-serif;
}

.toggle input {
  display: none;
}

.slider {
  position: absolute;
  width: 50%;
  height: 32px;
  background: white;
  border-radius: 16px;

  transition: .25s;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

input:checked + .slider {
  left: calc(50% + 4px);
}

.toggle_labels {
  display: flex;
  width: 100%;
  z-index: 2;
  font-size: 14px;
  font-weight: 600;
  color: #666;
  justify-content: space-between;
  padding: 0 0;
}

.toggle_labels div {
 margin-left: 10px;
 width: 50%;
 display: inline-block; /* ou block si tu veux que ça prenne toute la ligne */
    text-align: center;
}


</style>

<link href="https://api.mapbox.com/mapbox-gl-js/v3.16.0/mapbox-gl.css" rel="stylesheet">

<script src="https://api.mapbox.com/mapbox-gl-js/v3.16.0/mapbox-gl.js"></script>
<script src="https://unpkg.com/@turf/turf@^7/turf.min.js"></script>

</head>

<body>

<div id="map"></div>


<div class="togglebox">
  <p align="center" style="font-size:1.1em"><b>Choose health score</b></p>
  <label class="toggle">
    <input type="checkbox" id="toggleCQ">
    <div class="slider"></div>
    <div class="toggle_labels">
      <div>Quality</div>
      <div>Coverage</div>
    </div>
  </label>
</div>

<div class="infobox">
<b>Click on a country to see more informations ...</b>
</div>

<div id="mySidepanel" class="sidepanel">
    <span class='close-btn' onclick='closePanel()'>&times;</span>
    <div style='height:fit-content'>
      <div style='float: right;'>
        <img id="country-property-flag_image" src='http://x' style='margin-left: 15px;width:150px;'>
      </div>
      <div>
        <h2 style="width:320px"><span id="country-property-name">$country_name</span> (<span id="country-property-code_isoa2">$country_code</span>)</h2>
        <p><ul>
          <li><b>Population: </b><span id="country-property-population">$population</span></li>
          <li><b>Area: </b><span id="country-property-area_km2">$area_km2</span> km2</li>
          <li><b>GDP: </b><span id="country-property-gdp_bd">$gdp_bd</span> M$</li>
          <li><b>Number of power plants: </b><span id="country-property-power_plant_count">$power_plant_count</span></li>
          <li><b>Power plant capacity: </b><span id="country-property-power_plant_output_mw">$power_plant_output_mw</span> MW</li>
          <li><b>Power line length: </b><span id="country-property-power_line_total_length">$power_line_total_length</span> km</li>
          <li><b>Number of substations: </b><span id="country-property-stats_nb_substations">$stats_nb_substations</span></li>
          <li><b>Number of international connections: </b><span id="country-property-stats_nb_international_connections">$stats_nb_international_connections</span></li>
          <li><b>Line voltages: </b><span id="country-property-line_voltage">$line_voltage</span></li>
        </ul></p>
      </div>
    </div>

    <div id="externalLinksLogoLine">
        <!-- AUTO GENERATED -->
    </div>

    <br>

    <h3>Quality Score</h3>
    <div style='text-align: center;width:100%;'>
      <canvas id='ring_quality_score' width='250' height='120'></canvas>
    </div>
    <div class='container' id='quality_score_div'></div><br>
    <div style="text-align:center"><a href="indicatorsmethodo.html" target="_blank">See indicator computing methodology</a></div>

    <div id="voltage_section">
      <h3 id="voltage_headsection">Comparison of circuit lengths with official data</h3>
      <div style='text-align: center;width:100%;'>
        <canvas id='ring_coverage_score' width='250' height='120'></canvas>
      </div>
      <div id="voltage_comparaison_div" class="container" style='text-align: center;width:100%;'></div>
      <div style="text-align:center;margin-top:10px;">See official sources on <a id="voltage_source_osm_link" href="xxx" target="_blank">OSM Wiki</a> and on this <a href='https://docs.google.com/spreadsheets/d/1qmVIQ2_ynVVfbTWcMXJQWb4Sq0Dq-1fu8zgZ9J_0cZI/edit?usp=sharing' target="_blank">spreadsheet</a></div>
    </div>

    <div id="circuit_length_section">
    <h3 id="circuit_length_headsection">Circuit length (OSM Data)</h3>
    <div id="circuit_length_fig_hbar" style='text-align: center;width:100%;'></div>
    </div>

    <h3>Inhabited land near a substation</h3>
    <div style='text-align: center;width:100%;'>
      <canvas id='ring_spatialsubstation_score' width='250' height='120'></canvas>
    </div>

    <br><br><br><br>

</div>

<script src="data_voltage_length_official.js"></script>

<script>

    const health_indicators = ['health_power_line_connectivity',
    'health_grid_connectivity_without_circuit',
    'health_grid_connectivity_with_circuit',
    'health_line_voltage_completeness',
    'health_line_cables_completness',
    'health_line_circuits_completness',
    'health_substation_voltage_completness',
    'health_connected_power_tower',
    'health_complete_power_line',
    'health_consistent_line_voltage_connection',
    'health_consistent_linesub_voltage_connection'];

    const indicator_title = {'health_power_line_connectivity':'Line connectivity',
    'health_grid_connectivity_without_circuit':'Grid connectivity (without circuit)',
    'health_grid_connectivity_with_circuit':'Grid connectivity (with circuit)',
    'health_line_voltage_completeness':'"Voltage"-tag completeness on lines and cables',
    'health_line_cables_completness':'"Cables"-tag completeness on lines and cables',
    'health_line_circuits_completness':'"Circuits"-tag completeness on lines and cables',
    'health_substation_voltage_completness':'"Voltage"-tag completeness on substations',
    'health_connected_power_tower':'Connected power tower',
    'health_complete_power_line':'Completed power lines',
    'health_consistent_line_voltage_connection':'Line-to-line voltage consistency',
    'health_consistent_linesub_voltage_connection':'Line-to-Substation voltage consistency'};


</script>

<script>
// ------------------ MAPBOX Definition -----------------------

  let current_state = "";

  mapboxgl.accessToken = 'pk.eyJ1IjoiZHluYXJ0aW8iLCJhIjoiY21kY3d2NHJqMDF3azJtcjE4MW9pbXFzcCJ9.1b8Dmqyfv_xq3Hre_90pPg';
  const map = new mapboxgl.Map({
      container: 'map',
      // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
      style: 'mapbox://styles/dynartio/cmfit5dvi004u01qyhx04aif3',
      attributionControl: false,
       minZoom: 2,
      //center: [-96, 37.8],
      //zoom: 3
  });

  map.on('load', () => {
   /* map.addSource('worldmap-indicators', {
            'type': 'vector',
            'url': 'mapbox://dynartio.4x227vv0'
        });*/

  /*  map.addLayer({
        id: 'quality-score-layer',
        'slot': 'top',
        type: 'line',
        source: 'quality-score-layer',
        'source-layer': 'worldmap_indicators8-576zty',
        paint: {
          'line-color': '#666666',
          'line-width': 0.5,
          'line-opacity': 0.2,
        },
      }); */

   // ----------------------------------------------------
          // Create the popup UI, but don't add it to the map yet.
        // You only want the UI to appear once the cursor is hovering over an element.
   /*     const popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false
        });

        map.addInteraction('country-mouseleave-interaction', {
            type: 'mouseleave',
            target: { layerId: 'highlight-country' },
            handler: () => {
                //map.getCanvas().style.cursor = '';
                //popup.remove();
            }
        });

        map.addInteraction('country-mouseenter-interaction', {
            type: 'mouseenter',
            target: { layerId: 'highlight-country' },
            handler: (e) => {
                //map.getCanvas().style.cursor = 'pointer';

                // Copy the coordinates from the POI underneath the cursor
                //console.log(e);
                //const coordinates = e.features[0].geometry.centroid.coordinates.slice();
                //const description = e.feature[0].properties.description;

                // Populate the popup and set its coordinates based on the feature found.
                popup.setLngLat(e.lngLat).setHTML("INFO").addTo(map);
            }
        });
*/

  });



  map.addControl(new mapboxgl.AttributionControl({customAttribution: "<a href='https://mapyourgrid.org/' target='_blank'>MapYourGrid</a> | <a href='https://dynartio.com/' target='_blank'>Dynartio</a>"}));
  //map.addControl(new mapboxgl.FullscreenControl({container: document.querySelector('body')}));

  // ----------- Popup builder
  map.on('click', (event) => {
      // If the user clicked on one of your markers, get its information.
      const features = map.queryRenderedFeatures(event.point, {
        layers: ["quality-score-layer", "coverage-score-layer"] // replace with your layer(s) name
      });

      if (!features.length) {
        return;
      }
      const feature = features[0];

      buildPanel(feature.properties, event.lngLat);
  });


  function show_layer(healthScoreId) {
      if (healthScoreId=="quality") {
            map.setLayoutProperty("quality-score-layer", 'visibility', 'visible');
            map.setLayoutProperty("coverage-score-layer", 'visibility', 'none');
          } else if (healthScoreId=="coverage") {
            map.setLayoutProperty("quality-score-layer", 'visibility', 'none');
            map.setLayoutProperty("coverage-score-layer", 'visibility', 'visible');
          }
  }

</script>

<script>

let current_select = false;

const ctmap = document.getElementById("map");
const panel = document.getElementById("mySidepanel");
const externalLinksLogoLine = document.getElementById("externalLinksLogoLine");
const voltage_headsection = document.getElementById("voltage_headsection");
const voltage_comparaison_div = document.getElementById('voltage_comparaison_div');
//const voltage_headsection = document.getElementById("voltage_headsection");

const circuit_length_section = document.getElementById('circuit_length_section');
const circuit_length_fig_hbar = document.getElementById('circuit_length_fig_hbar');


const openinframap_name_exception = {
  "GM" : "Gambia",
  "SZ" : "Swaziland",
}

function closePanel() {
    panel.classList.remove("open");
    //ctmap.style.left = 0;
}

function buildPanel(feature_properties, ll) {
    let key="";

    key = "flag_image";
    const myelement = document.getElementById("country-property-" + key);
    myelement.src = "";
    myelement.src = "http://commons.wikimedia.org/wiki/Special:FilePath/" + feature_properties[key];

    const country_code_iso2 = feature_properties["code_isoa2"];

    let circuit_length_kv_km = null;
    if (feature_properties['circuit_length_kv_km'] !== undefined) {
        circuit_length_kv_km = JSON.parse(feature_properties.circuit_length_kv_km);
    }

    const country_property_list = ["name", "code_isoa2", "population", "area_km2", "gdp_bd", "power_plant_count", "power_plant_output_mw", "power_line_total_length", "stats_nb_substations", "stats_nb_international_connections", "line_voltage"];
    for (const prop of country_property_list) {

      const myspan = document.getElementById("country-property-" + prop);
      myspan.innerHTML = feature_properties[prop];
    }



    let htmlcontent = "";
    htmlcontent += "<p align='center'>";
    htmlcontent += "<a href='https://wiki.openstreetmap.org/wiki/Power_networks/" + feature_properties.name.replace(/ /g, "_")  + "' target='_blank'><img src='https://wiki.openstreetmap.org/osm_logo_wiki.png' width='50' class='mini-website-icon'></a>";
    if (feature_properties.wikidata_id !== undefined) {
      htmlcontent += "<a href='https://www.wikidata.org/wiki/" + feature_properties.wikidata_id + "' target='_blank'><img src='https://upload.wikimedia.org/wikipedia/commons/f/ff/Wikidata-logo.svg' class='mini-website-icon' width='60'></a>";
    }
    if (feature_properties["code_isoa2"] in openinframap_name_exception) {
        htmlcontent += "<a href='https://openinframap.org/stats/area/" + openinframap_name_exception[feature_properties["code_isoa2"]] + "' target='_blank'><img src='logo_openinframap.png' width='50' class='mini-website-icon'></a>";
    } else {
        htmlcontent += "<a href='https://openinframap.org/stats/area/" + feature_properties.name + "' target='_blank'><img src='logo_openinframap.png' width='50' class='mini-website-icon'></a>";
    }
     if (feature_properties.osm_rel_id !== undefined) {
      htmlcontent += "<a href='https://www.openstreetmap.org/relation/" + feature_properties.osm_rel_id + "' target='_blank'><img src='https://upload.wikimedia.org/wikipedia/commons/thumb/b/b0/Openstreetmap_logo.svg/80px-Openstreetmap_logo.svg.png' width='50' class='mini-website-icon'></a>";
      htmlcontent += "</p>";
     }


    panel.classList.add("open");
    externalLinksLogoLine.innerHTML = htmlcontent;


    buildQualityIndicatorDiv(feature_properties);

    // --------- CIRCUIT LENGTH DIV, only for country with data
    circuit_length_fig_hbar.innerHTML = "";
    if (circuit_length_kv_km !== null) {
        circuit_length_section.style.display="block";
        buildCircuitLengthHbar("circuit_length_fig_hbar", circuit_length_kv_km);
    } else {
       if (country_code_iso2 in data_voltage_length_osm) {
         circuit_length_section.style.display="block";
          buildCircuitLengthHbar("circuit_length_fig_hbar", data_voltage_length_osm[country_code_iso2]);
       } else {
           circuit_length_section.style.display="none";
         }

    }


    // ---------------- VOLTAGE DIV, only for country with official data
    voltage_section.style.display="none";
    voltage_comparaison_div.innerHTML = "";

    buildComparisonVoltageDiv2(country_code_iso2, feature_properties["name"], (feature_properties["coverage_score"]*100).toFixed(1), feature_properties["comparison_km_circuit_kv_off_osm"]);

  /* NOT WORKING PROPERLY
    if (current_select) {
	// Unhover the current feature
     console.log(feature);
		map.setFeatureState(
			{ sourceLayerId: 'highlight-country', source: 'worldmap-indicators', 'sourceLayer': 'worldmap_indicators-bbcgmb', id: current_select.id },
			{ hover: false }
		);
	}
	map.setFeatureState(
		{ sourceLayerId: 'highlight-country', source: 'worldmap-indicators', 'sourceLayer': 'worldmap_indicators-bbcgmb', id: feature.id },
		{ hover: true }
	);
	current_select = feature;*/

}


function buildQualityIndicatorDiv(feature_properties) {
  const container = document.getElementById('quality_score_div');
  container.innerHTML = "";

  for (const indicator of health_indicators) {
    if (indicator in feature_properties) {
      const div = document.createElement('div');
      div.className = 'card';

      const title = document.createElement('b');
      title.innerHTML = indicator_title[indicator];

      const canvas = document.createElement('canvas');
      canvas.id = "ring_" + indicator;
      canvas.width = 75;
      canvas.height = 75;

      div.appendChild(title);
      div.appendChild(canvas);
      container.appendChild(div);

      drawRing("ring_" + indicator, feature_properties[indicator].toFixed(1), "XXS");
    }
  };

  drawRing("ring_quality_score", (feature_properties["quality_score"]*100).toFixed(1), "XS");
  drawRing("ring_spatialsubstation_score", feature_properties["coverage_population"], "XS");
}

function buildComparisonVoltageDiv2(country_code, country_name, globalscore, datastring) {

  if (datastring === null) {
      return;
  } else if (datastring == "") {
      return;
  } else {
  console.log(datastring);
      const array_comparison = datastring.split(" ");

      array_comparison.forEach(item => {
          voltage_section.style.display="block";
          values = item.split(":");
          kv = values[0];
          off = parseInt(values[1]);
          osm = parseInt(values[2]);

          if (kv != "Total") {
            title = kv + " kV<br><i>(" + off.toString() + " km)</i>";
          } else {
            title = "Total<br><i>(" + off.toString() + " km)</i>";
          }

          pct = osm*100/off;
          cardid = "ring_n2_" + kv;
          buildRingCard(voltage_comparaison_div, cardid, title, pct.toFixed(1));
      });
      drawRing("ring_coverage_score", globalscore, "XS");
  }
}

function buildComparisonVoltageDiv(country_code, country_name, official_data, osm_data) {
  voltage_section.style.display="block";

  for (const [ myvoltage, mylength ] of Object.entries(official_data)) {

    cardid = "ring_" + myvoltage;
    cardtitle = myvoltage.toString() + " kV<br><i>(" + mylength.toString() + " km)</i>";
     let value_pct;
    if (osm_data === null) {
        value_pct = -1;
    } else {
        if (myvoltage in osm_data) {
      value_pct = (100*osm_data[myvoltage] / mylength).toFixed(1);
        } else {
          value_pct = 0;
        }
    }
    buildRingCard(voltage_comparaison_div, cardid, cardtitle, value_pct);
  }

  const awikipage = document.getElementById("voltage_source_osm_link");
  awikipage.href = "https://wiki.openstreetmap.org/wiki/Power_networks/" + country_name.replace(/ /g, "_") + "#Network_statistics";

}

function buildRingCard(container_div, ring_id, ring_title, ring_value) {
    const div = document.createElement('div');
    div.className = 'card';

    // Titre
    const title = document.createElement('b');
    title.innerHTML = ring_title;

    // Image (ici un placeholder, tu peux remplacer l'URL)
    const canvas = document.createElement('canvas');
    canvas.id = ring_id;
    canvas.width = 75;
    canvas.height = 75;

    div.appendChild(title);
    div.appendChild(canvas);
    container_div.appendChild(div);

    drawRing(ring_id, ring_value, "XXS");
}


function buildCircuitLengthHbar(hbarname, data) {
    // Trouver la valeur maximale
    const maxVal = Math.max(...Object.values(data));
    const chart = document.getElementById(hbarname);
    for (const [label, value] of Object.entries(data)) {
        if (label < 50) {
          continue;
        }
        const container = document.createElement("div");
        container.className = "fig_hbar_div";
        const lbl = document.createElement("div");
        lbl.className = "fig_hbar_label";
        lbl.textContent = label.toString() + " kV";
        const bar = document.createElement("div");
        bar.className = "fig_hbar_line_div";
        bar.style.width = `${(value / maxVal) * 60}%`;
        const val = document.createElement("div");
        val.className = "fig_hbar_value";
        val.textContent = Math.round(value).toString() + " km";
        container.append(lbl, bar, val);
        chart.appendChild(container);
    }
}

</script>


<script>

    function percentToColor(p) {
      // Interpolation entre rouge (0%) → jaune (seuil%) → vert (100%)
      let r, g, b = 0;
      let seuil=65;
      if (p < seuil) {
        // rouge -> jaune (rouge=255, vert=0→255)
        r = 255;
        g = Math.round(255 * (p / seuil));
      } else {
        // jaune -> vert (rouge=255→0, vert=255)
        g = 255;
        r = Math.round(255 * (1 - (p - seuil) / seuil));
      }
      return `rgb(${r},${g},${b})`;
    }

    function percentToColorOverflow(p) {
      // Interpolation entre rouge (0%) → jaune (seuil%) → vert (100%)
      let r, g, b = 0;
      let seuil=20;
      let minp = Math.min(40, p)
      if (p < seuil) {
        // rouge -> jaune (rouge=255, vert=0→255)
        g = 255;
        r = Math.round(255 * (p / seuil));
      } else {
        // jaune -> vert (rouge=255→0, vert=255)
        r = 255;
        g = Math.round(255 * (1 - (minp - seuil) / seuil));
        b = Math.round(255 * ((minp - seuil) / seuil));
      }
      return `rgb(${r},${g},${b})`;
    }

    function drawRing(ringname, percent, size) {
      const canvas = document.getElementById(ringname);
      const ctx = canvas.getContext("2d");

      // ----- Definition Element Size
      let element_size = {};
      if (size=="XXS") {
        element_size = {
          radius:30,
          lineWidth:10,
          font:"bold 11px sans-serif",
        };
      } else if (size=="XS") {
        element_size = {
          radius:45,
          lineWidth:14,
          font:"bold 14px sans-serif",
        };
      } else if (size=="S") {
        element_size = {
          radius:60,
          lineWidth:20,
          font:"bold 24px sans-serif",
        };
      } else {
        element_size = {
          radius:90,
          lineWidth:30,
          font:"bold 24px sans-serif",
        };
      }
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const startAngle = -Math.PI / 2; // commence en haut
        let endAngle = startAngle + (percent / 100) * 2 * Math.PI;
        if (percent == -1) {
            endAngle = startAngle + (0 / 100) * 2 * Math.PI;
        }

        // Anneau de fond
        ctx.beginPath();
        ctx.arc(canvas.width / 2, canvas.height / 2, element_size["radius"], 0, 2 * Math.PI);
        ctx.lineWidth = element_size["lineWidth"]-1;
        ctx.strokeStyle = "#444";
        ctx.stroke();

        // Progression
        ctx.beginPath();
        ctx.arc(canvas.width / 2, canvas.height / 2, element_size["radius"], startAngle, endAngle);
        ctx.strokeStyle = percentToColor(percent);
        ctx.lineWidth = element_size["lineWidth"];
        ctx.lineCap = "butt";
        ctx.stroke();

        //Create gradient
        /*var gradient = ctx.createLinearGradient(0,element_size["radius"],0, 0);
        gradient.addColorStop(0, '#f00');
        gradient.addColorStop(1, '#0f0');*/


        if (percent > 100) {
            endAngle = startAngle + ((percent-100) / 100) * 2 * Math.PI;
        // Progression
          ctx.beginPath();
          ctx.arc(canvas.width / 2, canvas.height / 2, element_size["radius"], startAngle, endAngle);
          ctx.strokeStyle = percentToColorOverflow(percent - 100); //gradient; //percentToColorOverflow(percent - 100);
          ctx.lineWidth = element_size["lineWidth"]+1;
          ctx.lineCap = "butt";
          ctx.stroke();
        }

        // Texte au centre
        ctx.fillStyle = "222";
        ctx.font = element_size["font"];
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        if (percent == -1) {
          ctx.fillText('??', canvas.width / 2, canvas.height / 2);
        } else {
          ctx.fillText(`${percent}%`, canvas.width / 2, canvas.height / 2);
        }
    }



  </script>

  <script>
  /* Toggle bouton management */

  const toggle = document.getElementById("toggleCQ");

  toggle.checked = false;

  toggle.addEventListener("change", () => {
    const value = toggle.checked ? "coverage" : "quality";
    change_toggle(value);
  });



  function change_toggle(val) {
    show_layer(val);
  }
/*map.on('sourcedata', (e)=> {
    if (map.loaded()) {
const current_value = toggle.checked ? "coverage" : "quality";
  console.log("Current_value = ", current_value);
  change_toggle(current_value);
    }
});*/


</script>


  </body>
</html>
